version: "3.9"

services:
  # =====================================
  # BACKEND API (FastAPI)
  # =====================================
  api:
    build:
      context: ./backend_fastapi
      dockerfile: Dockerfile.api

    container_name: dataops_api

    ports:
      - "8000:8000"

    environment:
      DATABASE_URL: sqlite+aiosqlite:////app/data/dataops.db
      LOG_LEVEL: INFO
      WORKER_ENABLED: "false"

    volumes:
      - ./backend_fastapi/data:/app/data
      - ./backend_fastapi/exports:/app/exports

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/liveness"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          memory: 256M


  # =====================================
  # BACKGROUND WORKER (Scraping / Jobs)
  # =====================================
  worker:
    build:
      context: ./backend_fastapi
      dockerfile: Dockerfile.worker

    container_name: dataops_worker

    environment:
      DATABASE_URL: sqlite+aiosqlite:////app/data/dataops.db
      LOG_LEVEL: INFO
      WORKER_ENABLED: "true"
      WORKER_CONCURRENCY: 1
      WORKER_POLL_INTERVAL: 5

    volumes:
      - ./backend_fastapi/data:/app/data
      - ./backend_fastapi/exports:/app/exports

    restart: unless-stopped

    depends_on:
      api:
        condition: service_healthy

    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 1.5G
        reservations:
          memory: 512M


  # =====================================
  # FRONTEND (Next.js / React)
  # =====================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile

    container_name: dataops_frontend

    ports:
      - "3000:3000"

    environment:
      NEXT_PUBLIC_API_URL: http://api:8000

    depends_on:
      api:
        condition: service_healthy

    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

